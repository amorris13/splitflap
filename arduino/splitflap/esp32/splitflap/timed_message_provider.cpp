/*
   Copyright 2021 Scott Bezek and the splitflap contributors

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
*/
#include "timed_message_provider.h"

static const SpecialMessage special_messages[] = {
    {1766577600, 240, {"GIS NZ"}}, {1766577840, 240, {"NAN FJ"}},
    {1766578080, 240, {"WLG NZ"}}, {1766578320, 240, {"AKL NZ"}},
    {1766578560, 240, {"CHC NZ"}}, {1766578800, 240, {"DUD NZ"}},
    {1766579040, 240, {"ZQN NZ"}}, {1766579280, 240, {"NLK NF"}},
    {1766579520, 240, {"NOU NC"}}, {1766579760, 240, {"HIR SB"}},
    {1766580000, 240, {"LDH AU"}}, {1766580240, 240, {"OOL AU"}},
    {1766580480, 240, {"BNE AU"}}, {1766580720, 240, {"MCY AU"}},
    {1766580960, 240, {"NTL AU"}}, {1766581200, 240, {"SYD AU"}},
    {1766581440, 240, {"CBR AU"}}, {1766581680, 240, {"HTI AU"}},
    {1766581920, 240, {"HBA AU"}}, {1766582160, 240, {"CNS AU"}},
    {1766582400, 240, {"MEL AU"}}, {1766582640, 240, {"GUM US"}},
    {1766582880, 240, {"AVV AU"}}, {1766583120, 240, {"CTS JP"}},
    {1766583360, 240, {"SDJ JP"}}, {1766583600, 240, {"NRT JP"}},
    {1766583840, 240, {"HND JP"}}, {1766584080, 240, {"ADL AU"}},
    {1766584320, 240, {"NGO JP"}}, {1766584560, 240, {"ITM JP"}},
    {1766584800, 240, {"KIX JP"}}, {1766585040, 240, {"UKB JP"}},
    {1766585280, 240, {"VVO RU"}}, {1766585520, 240, {"AYQ AU"}},
    {1766585760, 240, {"KMJ JP"}}, {1766586000, 240, {"KOJ JP"}},
    {1766586240, 240, {"FUK JP"}}, {1766586480, 240, {"OKA JP"}},
    {1766586720, 240, {"GMP KR"}}, {1766586960, 240, {"CJU KR"}},
    {1766587200, 240, {"ICN KR"}}, {1766587440, 240, {"HRB CN"}},
    {1766587680, 240, {"CGQ CN"}}, {1766587920, 240, {"CEB PH"}},
    {1766588160, 240, {"SHE CN"}}, {1766588400, 240, {"PVG CN"}},
    {1766588640, 240, {"TSA TW"}}, {1766588880, 240, {"DLC CN"}},
    {1766589120, 240, {"SHA CN"}}, {1766589360, 240, {"TPE TW"}},
    {1766589600, 240, {"MNL PH"}}, {1766589840, 240, {"HGH CN"}},
    {1766590080, 240, {"TAO CN"}}, {1766590320, 240, {"KHH TW"}},
    {1766590560, 240, {"UPG ID"}}, {1766590800, 240, {"NKG CN"}},
    {1766591040, 240, {"PPS PH"}}, {1766591280, 240, {"XMN CN"}},
    {1766591520, 240, {"TSN CN"}}, {1766591760, 240, {"PEK CN"}},
    {1766592000, 240, {"PKX CN"}}, {1766592240, 240, {"BKI MY"}},
    {1766592480, 240, {"PER AU"}}, {1766592720, 240, {"DPS ID"}},
    {1766592960, 240, {"WUH CN"}}, {1766593200, 240, {"HKG CN"}},
    {1766593440, 240, {"CGO CN"}}, {1766593680, 240, {"SZX CN"}},
    {1766593920, 240, {"MFM MO"}}, {1766594160, 240, {"CAN CN"}},
    {1766594400, 240, {"CSX CN"}}, {1766594640, 240, {"SUB ID"}},
    {1766594880, 240, {"TYN CN"}}, {1766595120, 240, {"HAK CN"}},
    {1766595360, 240, {"SYX CN"}}, {1766595600, 240, {"DAD VN"}},
    {1766595840, 240, {"SGN VN"}}, {1766595840, 240, {"CGK ID"}},
    {1766596320, 240, {"HAN VN"}}, {1766596560, 240, {"PNH KH"}},
    {1766596800, 240, {"TFU CN"}}, {1766597040, 240, {"SIN SG"}},
    {1766597280, 240, {"JHB MY"}}, {1766597520, 240, {"KMG CN"}},
    {1766597760, 240, {"KUL MY"}}, {1766598000, 240, {"BKK TH"}},
    {1766598240, 240, {"DMK TH"}}, {1766598480, 240, {"PEN MY"}},
    {1766598720, 240, {"KNO ID"}}, {1766598960, 240, {"HKT TH"}},
    {1766599200, 240, {"RGN MM"}}, {1766599440, 240, {"DAC BD"}},
    {1766599680, 240, {"CCU IN"}}, {1766599920, 240, {"KTM NP"}},
    {1766600160, 240, {"MAA IN"}}, {1766600400, 240, {"HYD IN"}},
    {1766600640, 240, {"BLR IN"}}, {1766600880, 240, {"DEL IN"}},
    {1766601120, 240, {"ALA KZ"}}, {1766601360, 240, {"COK IN"}},
    {1766601600, 240, {"GOI IN"}}, {1766601840, 240, {"MLE MV"}},
    {1766602080, 240, {"GAN MV"}}, {1766602320, 240, {"BOM IN"}},
    {1766602560, 240, {"ISB PK"}}, {1766602800, 240, {"AMD IN"}},
    {1766603040, 240, {"NQZ KZ"}}, {1766603280, 240, {"TAS UZ"}},
    {1766603520, 240, {"KHI PK"}}, {1766603760, 240, {"MCT OM"}},
    {1766604000, 240, {"MRU MU"}}, {1766604240, 240, {"SHJ AE"}},
    {1766604480, 240, {"RUN RE"}}, {1766604720, 240, {"DXB AE"}},
    {1766604960, 240, {"SEZ SC"}}, {1766605200, 240, {"DWC AE"}},
    {1766605440, 240, {"AUH AE"}}, {1766605680, 240, {"DOH QA"}},
    {1766605920, 240, {"THR IR"}}, {1766606160, 240, {"IKA IR"}},
    {1766606400, 240, {"BAH BH"}}, {1766606640, 240, {"GYD AZ"}},
    {1766606880, 240, {"DMM SA"}}, {1766607120, 240, {"KWI KW"}},
    {1766607360, 240, {"TNR MG"}}, {1766607600, 240, {"RUH SA"}},
    {1766607840, 240, {"TBS GE"}}, {1766608080, 240, {"EVN AM"}},
    {1766608320, 240, {"BGW IQ"}}, {1766608560, 240, {"AER RU"}},
    {1766608800, 240, {"MED SA"}}, {1766609040, 240, {"JED SA"}},
    {1766609280, 240, {"ADD ET"}}, {1766609520, 240, {"DME RU"}},
    {1766609760, 240, {"SVO RU"}}, {1766610000, 240, {"NBO KE"}},
    {1766610240, 240, {"AMM JO"}}, {1766610480, 240, {"BEY LB"}},
    {1766610720, 240, {"TLV IL"}}, {1766610960, 240, {"LCA CY"}},
    {1766611200, 240, {"ESB TR"}}, {1766611440, 240, {"PFO CY"}},
    {1766611680, 240, {"CAI EG"}}, {1766611920, 240, {"DUR ZA"}},
    {1766612160, 240, {"KBP UA"}}, {1766612400, 240, {"AYT TR"}},
    {1766612640, 240, {"LED RU"}}, {1766612880, 240, {"SAW TR"}},
    {1766613120, 240, {"DLM TR"}}, {1766613360, 240, {"IST TR"}},
    {1766613600, 240, {"JNB ZA"}}, {1766613840, 240, {"RHO GR"}},
    {1766614080, 240, {"OTP RO"}}, {1766614320, 240, {"VNO LT"}},
    {1766614560, 240, {"HER GR"}}, {1766614800, 240, {"HEL FI"}},
    {1766615040, 240, {"TLL EE"}}, {1766615280, 240, {"RIX LV"}},
    {1766615520, 240, {"ATH GR"}}, {1766615760, 240, {"SOF BG"}},
    {1766616000, 240, {"SKG GR"}}, {1766616240, 240, {"WAW PL"}},
    {1766616480, 240, {"BEG RS"}}, {1766616720, 240, {"KRK PL"}},
    {1766616960, 240, {"BUD HU"}}, {1766617200, 240, {"TOS NO"}},
    {1766617440, 240, {"CPT ZA"}}, {1766617680, 240, {"DBV HR"}},
    {1766617920, 240, {"ARN SE"}}, {1766618160, 240, {"VIE AT"}},
    {1766618400, 240, {"SPU HR"}}, {1766618640, 240, {"ZAG HR"}},
    {1766618880, 240, {"CTA IT"}}, {1766619120, 240, {"MLA MT"}},
    {1766619360, 240, {"NAP IT"}}, {1766619600, 240, {"PRG CZ"}},
    {1766619840, 240, {"BER DE"}}, {1766620080, 240, {"CPH DK"}},
    {1766620320, 240, {"CIA IT"}}, {1766620560, 240, {"VCE IT"}},
    {1766620800, 240, {"GOT SE"}}, {1766621040, 240, {"FCO IT"}},
    {1766621280, 240, {"MUC DE"}}, {1766621520, 240, {"BLQ IT"}},
    {1766621760, 240, {"OSL NO"}}, {1766622000, 240, {"NUE DE"}},
    {1766622240, 240, {"PSA IT"}}, {1766622480, 240, {"TUN TN"}},
    {1766622720, 240, {"HAM DE"}}, {1766622960, 240, {"HAJ DE"}},
    {1766623200, 240, {"LIN IT"}}, {1766623440, 240, {"STR DE"}},
    {1766623680, 240, {"BLL DK"}}, {1766623920, 240, {"MXP IT"}},
    {1766624160, 240, {"FRA DE"}}, {1766624400, 240, {"ZRH CH"}},
    {1766624640, 240, {"TRN IT"}}, {1766624880, 240, {"BSL CH"}},
    {1766625120, 240, {"NCE FR"}}, {1766625360, 240, {"CGN DE"}},
    {1766625600, 240, {"DUS DE"}}, {1766625840, 240, {"LUX LU"}},
    {1766626080, 240, {"GVA CH"}}, {1766626320, 240, {"EIN NL"}},
    {1766626560, 240, {"BGO NO"}}, {1766626800, 240, {"MRS FR"}},
    {1766627040, 240, {"LYS FR"}}, {1766627280, 240, {"AMS NL"}},
    {1766627520, 240, {"BRU BE"}}, {1766627760, 240, {"LOS NG"}},
    {1766628000, 240, {"ALG DZ"}}, {1766628240, 240, {"PMI ES"}},
    {1766628480, 240, {"CDG FR"}}, {1766628720, 240, {"ORY FR"}},
    {1766628960, 240, {"BVA FR"}}, {1766629200, 240, {"BCN ES"}},
    {1766629440, 240, {"IBZ ES"}}, {1766629680, 240, {"TLS FR"}},
    {1766629920, 240, {"STN GB"}}, {1766630160, 240, {"LCY GB"}},
    {1766630400, 240, {"ACC GH"}}, {1766630640, 240, {"LGW GB"}},
    {1766630880, 240, {"LTN GB"}}, {1766631120, 240, {"LHR GB"}},
    {1766631360, 240, {"VLC ES"}}, {1766631600, 240, {"ALC ES"}},
    {1766631840, 240, {"BOD FR"}}, {1766632080, 240, {"NTE FR"}},
    {1766632320, 240, {"BHX GB"}}, {1766632560, 240, {"MAN GB"}},
    {1766632800, 240, {"BRS GB"}}, {1766633040, 240, {"BIO ES"}},
    {1766633280, 240, {"EDI GB"}}, {1766633520, 240, {"MAD ES"}},
    {1766633760, 240, {"GLA GB"}}, {1766634000, 240, {"AGP ES"}},
    {1766634240, 240, {"SVQ ES"}}, {1766634480, 240, {"BFS GB"}},
    {1766634720, 240, {"DUB IE"}}, {1766634960, 240, {"CMN MA"}},
    {1766635200, 240, {"FAO PT"}}, {1766635440, 240, {"RAK MA"}},
    {1766635680, 240, {"OPO PT"}}, {1766635920, 240, {"SNN IE"}},
    {1766636160, 240, {"LIS PT"}}, {1766636400, 240, {"ACE ES"}},
    {1766636640, 240, {"FUE ES"}}, {1766636880, 240, {"LPA ES"}},
    {1766637120, 240, {"TFS ES"}}, {1766637360, 240, {"FNC PT"}},
    {1766637600, 240, {"DSS SN"}}, {1766637840, 240, {"AEY IS"}},
    {1766638080, 240, {"KEF IS"}}, {1766638320, 240, {"PDL PT"}},
    {1766638560, 240, {"REC BR"}}, {1766638800, 240, {"SSA BR"}},
    {1766639040, 240, {"FOR BR"}}, {1766639280, 240, {"SDU BR"}},
    {1766639520, 240, {"GIG BR"}}, {1766639760, 240, {"CNF BR"}},
    {1766640000, 240, {"GRU BR"}}, {1766640240, 240, {"CGH BR"}},
    {1766640480, 240, {"VCP BR"}}, {1766640720, 240, {"BSB BR"}},
    {1766640960, 240, {"SFJ GL"}}, {1766641200, 240, {"POA BR"}},
    {1766641440, 240, {"YYT CA"}}, {1766641680, 240, {"MVD UY"}},
    {1766641920, 240, {"AEP AR"}}, {1766642160, 240, {"EZE AR"}},
    {1766642400, 240, {"YHZ CA"}}, {1766642640, 240, {"SJU PR"}},
    {1766642880, 240, {"PUJ DO"}}, {1766643120, 240, {"SDQ DO"}},
    {1766643360, 240, {"SCL CL"}}, {1766643600, 240, {"BOS US"}},
    {1766643840, 240, {"BDL US"}}, {1766644080, 240, {"YUL CA"}},
    {1766644320, 240, {"JFK US"}}, {1766644560, 240, {"LGA US"}},
    {1766644800, 240, {"BOG CO"}}, {1766645040, 240, {"EWR US"}},
    {1766645280, 240, {"PHL US"}}, {1766645520, 240, {"MDE CO"}},
    {1766645760, 240, {"YOW CA"}}, {1766646000, 240, {"BWI US"}},
    {1766646240, 240, {"DCA US"}}, {1766646480, 240, {"LIM PE"}},
    {1766646720, 240, {"IAD US"}}, {1766646960, 240, {"RDU US"}},
    {1766647200, 240, {"PTY PA"}}, {1766647440, 240, {"YTZ CA"}},
    {1766647680, 240, {"YYZ CA"}}, {1766647920, 240, {"FLL US"}},
    {1766648160, 240, {"PIT US"}}, {1766648400, 240, {"MIA US"}},
    {1766648640, 240, {"CLT US"}}, {1766648880, 240, {"MCO US"}},
    {1766649120, 240, {"RSW US"}}, {1766649360, 240, {"CLE US"}},
    {1766649600, 240, {"HAV CU"}}, {1766649840, 240, {"TPA US"}},
    {1766650080, 240, {"CMH US"}}, {1766650320, 240, {"DTW US"}},
    {1766650560, 240, {"SJO CR"}}, {1766650800, 240, {"ATL US"}},
    {1766651040, 240, {"CVG US"}}, {1766651280, 240, {"IND US"}},
    {1766651520, 240, {"BNA US"}}, {1766651760, 240, {"CUN MX"}},
    {1766652000, 240, {"MDW US"}}, {1766652240, 240, {"ORD US"}},
    {1766652240, 240, {"MKE US"}}, {1766652720, 240, {"MEM US"}},
    {1766652960, 240, {"MSY US"}}, {1766653200, 240, {"STL US"}},
    {1766653440, 240, {"MSP US"}}, {1766653680, 240, {"MCI US"}},
    {1766653920, 240, {"HOU US"}}, {1766654160, 240, {"IAH US"}},
    {1766654400, 240, {"DAL US"}}, {1766654640, 240, {"DFW US"}},
    {1766654880, 240, {"YWG CA"}}, {1766655120, 240, {"AUS US"}},
    {1766655360, 240, {"SAT US"}}, {1766655600, 240, {"NLU MX"}},
    {1766655840, 240, {"MEX MX"}}, {1766656080, 240, {"MTY MX"}},
    {1766656320, 240, {"GDL MX"}}, {1766656560, 240, {"DEN US"}},
    {1766656800, 240, {"PVR MX"}}, {1766657040, 240, {"IPC CL"}},
    {1766657280, 240, {"SJD MX"}}, {1766657520, 240, {"SLC US"}},
    {1766657760, 240, {"PHX US"}}, {1766658000, 240, {"YEG CA"}},
    {1766658240, 240, {"YYC CA"}}, {1766658480, 240, {"LAS US"}},
    {1766658720, 240, {"TIJ MX"}}, {1766658960, 240, {"SAN US"}},
    {1766659200, 240, {"ONT US"}}, {1766659440, 240, {"SNA US"}},
    {1766659680, 240, {"BUR US"}}, {1766659920, 240, {"LAX US"}},
    {1766660160, 240, {"SMF US"}}, {1766660400, 240, {"SJC US"}},
    {1766660640, 240, {"OAK US"}}, {1766660880, 240, {"SEA US"}},
    {1766661120, 240, {"SFO US"}}, {1766661360, 240, {"PDX US"}},
    {1766661600, 240, {"YVR CA"}}, {1766661840, 240, {"PPT PF"}},
    {1766662080, 240, {"ANC US"}}, {1766662320, 240, {"RFF PF"}},
    {1766662560, 240, {"BOB PF"}}, {1766662800, 240, {"KOA US"}},
    {1766663040, 240, {"OGG US"}}, {1766663280, 240, {"HNL US"}},
    {1766663520, 240, {"LIH US"}}, {1766663760, 240, {"RAR CK"}},
};

TimedMessageProvider::TimedMessageProvider(DisplayTask& display_task,
                                           Logger& logger)
    : display_task_(display_task), logger_(logger) {}

FetchResult TimedMessageProvider::fetchData() {
  time_t now_time;
  time(&now_time);

  log_d("TimedMessageProvider fetch");
  for (const auto& sm : special_messages) {
    if (now_time >= sm.start_time &&
        now_time < sm.start_time + sm.duration_seconds) {
      if (current_messages_ != sm.messages) {
        current_messages_ = sm.messages;
        log_d("Timed Message (update): %s", sm.messages[0]);
        display_task_.setMessage(
            2, String("Timed Message (up): ") + sm.messages[0]);
        return FetchResult::UPDATE;
      }
      log_d("Timed Message (no change): %s", sm.messages[0]);
      display_task_.setMessage(2,
                               String("Timed Message (nc): ") + sm.messages[0]);
      return FetchResult::NO_CHANGE;
    }
  }
  if (!current_messages_.empty()) {
    log_d("Timed Message (clear)");
    display_task_.setMessage(2, String("Timed Message (clr)"));
    current_messages_.clear();
    return FetchResult::UPDATE;
  }
  log_d("Timed Message (no message)");
  display_task_.setMessage(2, String("Timed Message (no msg)"));
  return FetchResult::NO_CHANGE;
}

const std::vector<String>& TimedMessageProvider::getMessages() {
  return current_messages_;
}
